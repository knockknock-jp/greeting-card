var bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;$(function(){var t,e,n,i,s,o,a,r,h,c,_,l,u,p,g,d,m,f,v,y,b,C,S,w,k,x,P,D,M,T;return n=$(window),e=$("html"),t=$("body"),("undefined"==typeof P||null===P)&&(P={}),("undefined"==typeof M||null===M)&&(M={}),null==M.picture&&(M.picture={}),("undefined"==typeof D||null===D)&&(D={}),s=260,i=260,a="./images/stamp/stamp-00.png",d="id_modal_file",g="id_modal_danger",f="id_modal_stamp",m="id_modal_msg",v="id_modal_upload",_="event_draw_image",r="event_add_history",u="event_start_drag_and_drop",l="event_open_modal",h="event_change_tool",c="event_clear",C=function(){function t(){var t;this._isPC=!0,t=window.navigator.userAgent.toLowerCase(),0<=t.indexOf("iphone")||0<=t.indexOf("ipad")||0<=t.indexOf("ipod")?this._isPC=!1:0<=t.indexOf("windows")&&0<=t.indexOf("phone")?this._isPC=!1:0<=t.indexOf("android")&&0<=t.indexOf("mobile")?this._isPC=!1:0<=t.indexOf("firefox")&&0<=t.indexOf("mobile")?this._isPC=!1:0<=t.indexOf("blackberry")&&(this._isPC=!1),this._isEdited=!1,this._isEnabledPen=!1,this._isEnabledStamp=!1,this._penOpacity=1,this._penThickness=3,this._penColor="#333333",this._stampImg=null,this._stampOpacity=1,this._stampSize=50,this._stampIsFlipHorizontal=!1,this._stampIsFlipVertical=!1}return t.prototype.getIsPc=function(){return Boolean(this._isPC)},t.prototype.setIsEdited=function(t){return"false"===t||t===!1?this._isEdited=!1:"true"===t||t===!0?this._isEdited=!0:void 0},t.prototype.getIsEdited=function(){return Boolean(this._isEdited)},t.prototype.setPenOpacity=function(t){return this._penOpacity=Number(t)},t.prototype.getPenOpacity=function(){return Number(this._penOpacity)},t.prototype.setPenThickness=function(t){return this._penThickness=Number(t)},t.prototype.getPenThickness=function(){return Number(this._penThickness)},t.prototype.setPenColor=function(t){return this._penColor=String(t)},t.prototype.getPenColor=function(){return String(this._penColor)},t.prototype.setStampImg=function(t){return this._stampImg=t},t.prototype.getStampImg=function(){return this._stampImg},t.prototype.setStampOpacity=function(t){return this._stampOpacity=Number(t)},t.prototype.getStampOpacity=function(){return Number(this._stampOpacity)},t.prototype.setStampSize=function(t){return this._stampSize=Number(t)},t.prototype.getStampSize=function(){return Number(this._stampSize)},t.prototype.setStampIsFlipHorizontal=function(t){return"false"===t||t===!1?this._stampIsFlipHorizontal=!1:"true"===t||t===!0?this._stampIsFlipHorizontal=!0:void 0},t.prototype.getStampIsFlipHorizontal=function(){return Boolean(this._stampIsFlipHorizontal)},t.prototype.setStampIsFlipVertical=function(t){return"false"===t||t===!1?this._stampIsFlipVertical=!1:"true"===t||t===!0?this._stampIsFlipVertical=!0:void 0},t.prototype.getStampIsFlipVertical=function(){return Boolean(this._stampIsFlipVertical)},t.prototype.setIsEnabledPen=function(t){return"false"===t||t===!1?this._isEnabledPen=!1:"true"===t||t===!0?this._isEnabledPen=!0:void 0},t.prototype.getIsEnabledPen=function(){return Boolean(this._isEnabledPen)},t.prototype.setIsEnabledStamp=function(t){return"false"===t||t===!1?this._isEnabledStamp=!1:"true"===t||t===!0?this._isEnabledStamp=!0:void 0},t.prototype.getIsEnabledStamp=function(){return Boolean(this._isEnabledStamp)},t}(),p=function(){function e(t){this._onClickBtnSlideshow=bind(this._onClickBtnSlideshow,this),this._onClickBtnGallery=bind(this._onClickBtnGallery,this),this._onClickBtnCreate=bind(this._onClickBtnCreate,this),this._onClickBtnLogo=bind(this._onClickBtnLogo,this),this._$target=t.$target,this._$btnLogo=$("#js-headerBtnLogo"),this._$btnCreate=$("#js-headerBtnCreate"),this._$btnGallery=$("#js-headerBtnGallery"),this._$btnSlideshow=$("#js-headerBtnSlideshow"),this._$btnLogo.on("click",this._onClickBtnLogo),this._$btnCreate.on("click",this._onClickBtnCreate),this._$btnGallery.on("click",this._onClickBtnGallery),this._$btnSlideshow.on("click",this._onClickBtnSlideshow)}return e.prototype._onClickBtnLogo=function(t){return t.preventDefault(),this._changeLocation({msg:"Home",url:"./index.html"})},e.prototype._onClickBtnCreate=function(t){return t.preventDefault(),this._changeLocation({msg:"Create",url:"./create.html"})},e.prototype._onClickBtnGallery=function(t){return t.preventDefault(),this._changeLocation({msg:"Gallery",url:"./gallery.html"})},e.prototype._onClickBtnSlideshow=function(t){return t.preventDefault(),this._changeLocation({msg:"Slideshow",url:"./slideshow.html"})},e.prototype._changeLocation=function(e){return T.getIsEdited()?t.trigger(l,[{id:g,data:{ttl:"Danger",msg:"&nbsp;"+e.msg+"ページに遷移する場合、現在編集中のカードは削除されますがよろしいですか？",agree:function(t){return function(){return location.href=e.url}}(this)}}]):location.href=e.url},e}(),o=function(){function e(t){this._onSaved=bind(this._onSaved,this),this._onClickOk=bind(this._onClickOk,this),this._onClickBack=bind(this._onClickBack,this),this._onClickClear=bind(this._onClickClear,this),this._$target=t.$target,this._$canvas=$("#js-canvasCanvas"),this._$btnOk=$("#js-canvasBtnOk"),this._$btnClear=$("#js-canvasBtnClear"),this._$btnBack=$("#js-canvasBtnBack"),this._context=this._$canvas.get(0).getContext("2d"),T.getIsPc()?(this._pen=new P.PenPc({$canvas:this._$canvas,context:this._context}),this._stamp=new P.StampPc({$canvas:this._$canvas,context:this._context})):(this._pen=new P.PenSp({$canvas:this._$canvas,context:this._context}),this._stamp=new P.StampSp({$canvas:this._$canvas,context:this._context})),this._imageDataArr=[],this._$btnClear.on("click",this._onClickClear),this._$btnBack.on("click",this._onClickBack),this._$btnOk.on("click",this._onClickOk)}return e.prototype.drawImage=function(t){return this._context.globalAlpha=t.opacity,this._context.drawImage(t.target,t.x,t.y,t.width,t.height)},e.prototype.addHistory=function(){return this._imageDataArr.push(this._context.getImageData(0,0,s,i)),this._setBtnActivate(),T.setIsEdited(!0)},e.prototype.startDragAndDrop=function(){return this._$canvas.get(0).addEventListener("dragover",function(t){return t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"},!1),this._$canvas.get(0).addEventListener("drop",function(e){return function(e){var n;return e.stopPropagation(),e.preventDefault(),n=new FileReader,n.readAsDataURL(e.dataTransfer.files[0]),n.onload=function(){var e;return e=new Image,e.src=n.result,e.onload=function(){var n,o,a,h;return i/e.height<s/e.width?(o=s,n=s*(e.height/e.width),a=0,h=-(n-i)/2):(o=i*(e.width/e.height),n=i,a=-(o-s)/2,h=0),t.trigger(_,[{target:e,x:a,y:h,width:o,height:n}]),t.trigger(r)}}}}(this),!1)},e.prototype.changTool=function(){return T.getIsEnabledPen()?(this._pen.setActive(),this._stamp.deleteActive()):T.getIsEnabledStamp()?(this._pen.deleteActive(),this._stamp.setActive()):(this._pen.deleteActive(),this._stamp.deleteActive())},e.prototype.clear=function(){return this._imageDataArr=[],this._context.clearRect(0,0,s,i),this._setBtnActivate(),T.setIsEdited(!1)},e.prototype._onClickClear=function(){return t.trigger(l,[{id:g,data:{ttl:"Danger",msg:"&nbsp;カードを削除しますがよろしいですか？",agree:function(t){return function(){return t.clear()}}(this)}}])},e.prototype._onClickBack=function(){var t,e,n,i,s,o;if(2<=this._imageDataArr.length){for(t=[],o=this._imageDataArr,e=i=0,s=o.length;s>i;e=++i)n=o[e],e<this._imageDataArr.length-1&&t.push(n);return this._imageDataArr=t,this._context.putImageData(this._imageDataArr[this._imageDataArr.length-1],0,0),this._setBtnActivate()}return this.clear()},e.prototype._onClickOk=function(){return t.trigger(l,[{id:m,data:{src:this._$canvas.get(0).toDataURL(),save:function(t){return function(e){return t._onSaved({name:e.name,msg:e.msg,pw:e.pw})}}(this)}}])},e.prototype._onSaved=function(e){return t.trigger(l,[{id:v,data:{src:this._$canvas.get(0).toDataURL(),name:e.name,msg:e.msg,pw:e.pw}}])},e.prototype._setBtnActivate=function(){return 1<=this._imageDataArr.length?(this._$btnOk.prop("disabled",!1),this._$btnClear.prop("disabled",!1),this._$btnBack.prop("disabled",!1)):(this._$btnOk.prop("disabled",!0),this._$btnClear.prop("disabled",!0),this._$btnBack.prop("disabled",!0))},e}(),P.PenPc=function(){function e(t){this._onMouseLeave=bind(this._onMouseLeave,this),this._onMouseUp=bind(this._onMouseUp,this),this._onMouseMove=bind(this._onMouseMove,this),this._onMouseDown=bind(this._onMouseDown,this),this._onMouseEnter=bind(this._onMouseEnter,this),this._$canvas=t.$canvas,this._context=t.context,this._startX=null,this._startY=null,this._imageData=null,this._isDrawing=!1}return e.prototype.setActive=function(){return this._$canvas.on("mouseenter",this._onMouseEnter),this._$canvas.on("mousedown",this._onMouseDown),this._$canvas.on("mousemove",this._onMouseMove),this._$canvas.on("mouseup",this._onMouseUp),this._$canvas.on("mouseleave",this._onMouseLeave)},e.prototype.deleteActive=function(){return this._$canvas.off("mouseenter",this._onMouseEnter),this._$canvas.off("mousedown",this._onMouseDown),this._$canvas.off("mousemove",this._onMouseMove),this._$canvas.off("mouseup",this._onMouseUp),this._$canvas.off("mouseleave",this._onMouseLeave)},e.prototype._onMouseEnter=function(t){return t.preventDefault(),this._context.lineCap="round",this._context.lineJoin="round",this._context.strokeStyle=T.getPenColor(),this._context.lineWidth=T.getPenThickness(),this._context.globalAlpha=T.getPenOpacity(),this._startX=t.pageX-$(t.target).offset().left,this._startY=t.pageY-$(t.target).offset().top,this._imageData=this._context.getImageData(0,0,s,i),this._onMouseMove(t)},e.prototype._onMouseDown=function(t){return t.preventDefault(),this._isDrawing=!0,this._startX=t.pageX-$(t.target).offset().left,this._startY=t.pageY-$(t.target).offset().top,this._onMouseMove(t)},e.prototype._onMouseMove=function(t){var e,n;return t.preventDefault(),this._isDrawing||this._imageData&&this._context.putImageData(this._imageData,0,0),e=t.pageX-$(t.target).offset().left,n=t.pageY-$(t.target).offset().top,this._context.beginPath(),this._context.moveTo(this._startX,this._startY),this._context.lineTo(e+.1,n+.1),this._context.closePath(),this._context.stroke(),this._startX=e,this._startY=n,this._isDrawing?this._imageData=this._context.getImageData(0,0,s,i):void 0},e.prototype._onMouseUp=function(e){return e.preventDefault(),this._isDrawing?(t.trigger(r),this._isDrawing=!1):void 0},e.prototype._onMouseLeave=function(e){return e.preventDefault(),this._imageData&&(this._context.putImageData(this._imageData,0,0),this._imageData=null),this._isDrawing?(t.trigger(r),this._isDrawing=!1):void 0},e}(),P.PenSp=function(){function e(t){this._onTouchEnd=bind(this._onTouchEnd,this),this._onTouchMove=bind(this._onTouchMove,this),this._onTouchStart=bind(this._onTouchStart,this),this._$canvas=t.$canvas,this._context=t.context,this._startX=null,this._startY=null}return e.prototype.setActive=function(){return this._$canvas.on("touchstart",this._onTouchStart),this._$canvas.on("touchmove",this._onTouchMove),this._$canvas.on("touchend",this._onTouchEnd)},e.prototype.deleteActive=function(){return this._$canvas.off("touchstart",this._onTouchStart),this._$canvas.off("touchmove",this._onTouchMove),this._$canvas.off("touchend",this._onTouchEnd)},e.prototype._onTouchStart=function(t){return t.preventDefault(),this._context.lineCap="round",this._context.lineJoin="round",this._context.strokeStyle=T.getPenColor(),this._context.lineWidth=T.getPenThickness(),this._context.globalAlpha=T.getPenOpacity(),this._startX=t.originalEvent.touches[0].clientX-$(t.target).offset().left,this._startY=t.originalEvent.touches[0].clientY-$(t.target).offset().top+n.scrollTop(),this._onTouchMove(t)},e.prototype._onTouchMove=function(t){var e,i;return t.preventDefault(),e=t.originalEvent.touches[0].clientX-$(t.target).offset().left,i=t.originalEvent.touches[0].clientY-$(t.target).offset().top+n.scrollTop(),this._context.beginPath(),this._context.moveTo(this._startX,this._startY),this._context.lineTo(e+.1,i+.1),this._context.closePath(),this._context.stroke(),this._startX=e,this._startY=i},e.prototype._onTouchEnd=function(e){return e.preventDefault(),t.trigger(r),this._isDrawing=!1},e}(),P.BaseStamp=function(){function e(t){this._$canvas=t.$canvas,this._context=t.context,this._img=null,this._size=null,this._imageData=null}return e.prototype._draw=function(e,n){var o,a;return this._context.save(),o=T.getStampIsFlipHorizontal(),a=T.getStampIsFlipVertical(),o&&!a?(this._context.scale(-1,1),this._context.translate(-s,0),e=s-e-this._size):!o&&a?(this._context.scale(1,-1),this._context.translate(0,-i),n=i-n-this._size):o&&a&&(this._context.scale(-1,-1),this._context.translate(-s,-i),e=s-e-this._size,n=i-n-this._size),t.trigger(_,[{target:this._img,x:e,y:n,width:this._size,height:this._size,opacity:T.getStampOpacity()}]),this._context.restore()},e}(),P.StampPc=function(e){function n(t){this._onMouseLeave=bind(this._onMouseLeave,this),this._onMouseDown=bind(this._onMouseDown,this),this._onMouseMove=bind(this._onMouseMove,this),this._onMouseEnter=bind(this._onMouseEnter,this),n.__super__.constructor.call(this,t)}return extend(n,e),n.prototype.setActive=function(){return this._$canvas.on("mouseenter",this._onMouseEnter),this._$canvas.on("mousedown",this._onMouseDown),this._$canvas.on("mousemove",this._onMouseMove),this._$canvas.on("mouseleave",this._onMouseLeave)},n.prototype.deleteActive=function(){return this._$canvas.off("mouseenter",this._onMouseEnter),this._$canvas.off("mousedown",this._onMouseDown),this._$canvas.off("mousemove",this._onMouseMove),this._$canvas.off("mouseleave",this._onMouseLeave)},n.prototype._onMouseEnter=function(t){return t.preventDefault(),this._img=T.getStampImg(),this._size=T.getStampSize(),this._imageData=this._context.getImageData(0,0,s,i),this._onMouseMove(t)},n.prototype._onMouseMove=function(t){var e,n;return t.preventDefault(),e=t.pageX-$(t.target).offset().left-this._size/2,n=t.pageY-$(t.target).offset().top-this._size/2,this._imageData&&this._context.putImageData(this._imageData,0,0),this._draw(e,n)},n.prototype._onMouseDown=function(e){var n,o;return e.preventDefault(),this._imageData&&this._context.putImageData(this._imageData,0,0),n=e.pageX-$(e.target).offset().left-this._size/2,o=e.pageY-$(e.target).offset().top-this._size/2,this._draw(n,o),this._imageData=this._context.getImageData(0,0,s,i),t.trigger(r)},n.prototype._onMouseLeave=function(t){return this._imageData?this._context.putImageData(this._imageData,0,0):void 0},n}(P.BaseStamp),P.StampSp=function(e){function o(t){this._onTouchEnd=bind(this._onTouchEnd,this),this._onTouchMove=bind(this._onTouchMove,this),this._onTouchStart=bind(this._onTouchStart,this),o.__super__.constructor.call(this,t),this._x=0,this._y=0,this._isEnter=!1}return extend(o,e),o.prototype.setActive=function(){return this._$canvas.on("touchstart",this._onTouchStart),this._$canvas.on("touchmove",this._onTouchMove),this._$canvas.on("touchend",this._onTouchEnd)},o.prototype.deleteActive=function(){return this._$canvas.off("touchstart",this._onTouchStart),this._$canvas.off("touchmove",this._onTouchMove),this._$canvas.off("touchend",this._onTouchEnd)},o.prototype._onTouchStart=function(t){return t.preventDefault(),this._img=T.getStampImg(),this._size=T.getStampSize(),this._imageData=this._context.getImageData(0,0,s,i),this._onTouchMove(t)},o.prototype._onTouchMove=function(t){var e,o,a,r;return t.preventDefault(),e=t.originalEvent.touches[0].clientX,o=t.originalEvent.touches[0].clientY+n.scrollTop(),r=$(t.target).offset().top,a=$(t.target).offset().left,this._imageData&&this._context.putImageData(this._imageData,0,0),0>e-a||e-a>s?void(this._isEnter=!1):0>o-r||o-r>i?void(this._isEnter=!1):(this._isEnter=!0,this._x=e-a-this._size/2,this._y=o-r-this._size/2,this._draw(this._x,this._y))},o.prototype._onTouchEnd=function(e){return e.preventDefault(),this._isEnter?(this._imageData&&this._context.putImageData(this._imageData,0,0),this._draw(this._x,this._y),t.trigger(r)):void 0},o}(P.BaseStamp),b=function(){function e(e){this._$target=e.$target,this._$tabPicture=$("#js-toolTabPicture"),this._$tabPen=$("#js-toolTabPen"),this._$tabStamp=$("#js-toolTabStamp"),this._picture=new M.Picture({$target:$("#js-toolPicture")}),this._pen=new M.Pen({$target:$("#js-toolPen")}),this._stamp=new M.Stamp({$target:$("#js-toolStamp")}),this._$tabPicture.on("shown.bs.tab",function(t){return function(e){return t._onChangeTab({id:"picture"})}}(this)),this._$tabPen.on("shown.bs.tab",function(t){return function(e){return t._onChangeTab({id:"pen"})}}(this)),this._$tabStamp.on("shown.bs.tab",function(t){return function(e){return t._onChangeTab({id:"stamp"})}}(this)),t.trigger(h)}return e.prototype._onChangeTab=function(e){return"picture"===e.id?(T.setIsEnabledPen(!1),T.setIsEnabledStamp(!1)):"pen"===e.id?(T.setIsEnabledPen(!0),T.setIsEnabledStamp(!1)):"stamp"===e.id&&(T.setIsEnabledPen(!1),T.setIsEnabledStamp(!0)),t.trigger(h)},e}(),M.Picture=function(){function t(t){this._$target=t.$target,this._file=new M.picture.File({$target:$("#js-toolPictureFile")}),this._camera=new M.picture.Camera({$target:$("#js-toolPictureCamera")}),this._dragAndDrop=new M.picture.DragAndDrop({$target:$("#js-toolPictureDragAndDrop")})}return t}(),M.picture.File=function(){function e(t){return this._onChange=bind(this._onChange,this),this._$target=t.$target,window.File&&window.FileReader&&window.FileList&&window.Blob?(this._$inputFile=$("#js-toolPictureFileInputFile"),void this._$inputFile.on("change",this._onChange)):void this._$target.css({display:"none"})}return e.prototype._onChange=function(e){var n,o;return T.getIsPc()?(n=e.target.files[0],o=new FileReader,o.readAsDataURL(n),o.onload=function(e){return function(e){return t.trigger(l,[{id:d,data:{src:o.result}}],!1)}}(this)):loadImage(e.target.files[0],function(e){return function(e){return t.trigger(l,[{id:d,data:{img:e}}],!1)}}(this),{maxWidth:2*s,maxHeight:2*i,minWidth:s,minHeight:i,canvas:!0,orientation:6})},e}(),M.picture.Camera=function(){function e(t){return this._onClickStop=bind(this._onClickStop,this),this._onClickCapture=bind(this._onClickCapture,this),this._onClickPlay=bind(this._onClickPlay,this),this._$target=t.$target,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null,navigator.getUserMedia?(this._$video=$("#js-toolPictureCameraVideo"),this._$btnPlay=$("#js-toolPictureCameraBtnPlay"),this._$btnStop=$("#js-toolPictureCameraBtnStop"),this._$btnStop2=$("#js-toolPictureCameraBtnStop2"),this._$btnCapture=$("#js-toolPictureCameraBtnCapture"),this._localMediaStream=null,this._isPlay=!1,this._$btnStop.css({display:"block"}),this._$btnCapture.css({display:"block"}),this._$btnPlay.on("click",this._onClickPlay),this._$btnCapture.on("click",this._onClickCapture),this._$btnStop.on("click",this._onClickStop),void this._$btnStop2.on("click",this._onClickStop)):void this._$target.css({display:"none"})}return e.prototype._onClickPlay=function(){var t;return this._toggleView(),t=!1,$("html, body").animate({scrollTop:1},500,"swing",function(e){return function(){return t?(window.URL=window.URL||window.webkitURL,navigator.getUserMedia({video:!0},function(t){return e._$video.get(0).src=window.URL.createObjectURL(t),e._$video.get(0).play(),e._localMediaStream=t},function(t){return console.log("Error : "+t)})):void(t=!0)}}(this))},e.prototype._onClickCapture=function(){return this._toggleView(),t.trigger(_,[{target:this._$video.get(0),x:-43,y:0,width:346,height:i}]),t.trigger(r),this._localMediaStream?(this._localMediaStream.stop(),this._localMediaStream=null):void 0},e.prototype._onClickStop=function(){return this._toggleView(),this._localMediaStream?(this._localMediaStream.stop(),this._localMediaStream=null):void 0},e.prototype._toggleView=function(){return this._isPlay?(this._$video.css({display:"none"}),this._$btnCapture.prop("disabled",!0),this._$btnPlay.css({display:"block"}),this._$btnStop.prop("disabled",!0),this._$btnStop2.css({display:"none"})):(this._$video.css({display:"block"}),this._$btnCapture.prop("disabled",!1),this._$btnPlay.css({display:"none"}),this._$btnStop.prop("disabled",!1),this._$btnStop2.css({display:"block"})),this._isPlay=!this._isPlay},e}(),M.picture.DragAndDrop=function(){function e(e){return this._$target=e.$target,T.getIsPc()?void t.trigger(u):void this._$target.css({display:"none"})}return e}(),M.Pen=function(){function t(t){this._$target=t.$target,this._$preview=$("#js-toolPenPreview"),this._$canvas=$("#js-toolPenCanvas"),this._context=this._$canvas.get(0).getContext("2d"),this._canvasSize=0,this._changeOpacity({val:$("#js-toolPenOpacity").find(":selected").val()}),this._changeThickness({val:$("input[name=js-toolPenThickness]:checked").val()}),this._changeColor({val:$("input[name=js-toolPenColor]:checked").val()}),this._setPreview(),$("#js-toolPenOpacity").on("change",function(t){return function(e){return t._changeOpacity({val:$(e.target).val()}),t._setPreview()}}(this)),$("input[name=js-toolPenThickness]").on("change",function(t){return function(e){return t._changeThickness({val:$(e.target).val()}),t._setPreview()}}(this)),$("input[name=js-toolPenColor]").on("change",function(t){return function(e){return t._changeColor({val:$(e.target).val()}),t._setPreview()}}(this))}return t.prototype._changeOpacity=function(t){return T.setPenOpacity(Number(t.val))},t.prototype._changeThickness=function(t){var e;return e=Number(t.val),this._canvasSize=e,this._canvasSize<60&&(this._canvasSize=60),this._$preview.css({width:this._canvasSize+32}),this._$canvas.css({width:this._canvasSize,height:this._canvasSize}),T.setPenThickness(e)},t.prototype._changeColor=function(t){return T.setPenColor(String(t.val))},t.prototype._setPreview=function(){var t,e;return this._context.clearRect(0,0,this._canvasSize,this._canvasSize),t=this._canvasSize/2,e=this._canvasSize/2,this._context.save(),this._context.globalAlpha=T.getPenOpacity(),this._context.lineCap="round",this._context.lineJoin="round",this._context.strokeStyle=T.getPenColor(),this._context.lineWidth=T.getPenThickness(),this._context.beginPath(),this._context.moveTo(t,e),this._context.lineTo(t+.1,e+.1),this._context.closePath(),this._context.stroke(),this._context.restore()},t}(),M.Stamp=function(){function e(t){this._openStampModal=bind(this._openStampModal,this),this._$target=t.$target,this._$preview=$("#js-toolStampPreview"),this._$canvas=$("#js-toolStampCanvas"),this._$btnType=$("#js-toolStampBtnType"),this._context=this._$canvas.get(0).getContext("2d"),this._canvasSize=0,this._changeOpacity({val:$("#js-toolStampOpacity").find(":selected").val()}),this._changeSize({val:$("#js-toolStampSize").find(":selected").val()}),this._changeFlip(),$("<img>").attr("src",a).on("load",function(t){return function(e){return t._changeType({img:e.target}),t._setPreview()}}(this)),this._$btnType.on("click",this._openStampModal),$("#js-toolStampOpacity").on("change",function(t){return function(e){return t._changeOpacity({val:$(e.target).val()}),t._setPreview()}}(this)),$("#js-toolStampSize").on("change",function(t){return function(e){return t._changeSize({val:$(e.target).val()}),t._setPreview()}}(this)),$("input[name=js-toolStampFlip]").on("change",function(t){return function(){return t._changeFlip(),t._setPreview()}}(this))}return e.prototype._openStampModal=function(){return t.trigger(l,[{id:f,data:{select:function(t){return function(e){return t._changeType({img:e.img}),t._setPreview()}}(this)}}])},e.prototype._changeFlip=function(){var t,e;return t=!1,e=!1,$("input[name=js-toolStampFlip]:checked").each(function(n){return function(n,i){return"horizontal"===$(i).val()&&(t=!0),"vertical"===$(i).val()?e=!0:void 0}}(this)),T.setStampIsFlipHorizontal(t),T.setStampIsFlipVertical(e)},e.prototype._changeOpacity=function(t){return T.setStampOpacity(Number(t.val))},e.prototype._changeSize=function(t){return this._canvasSize=Number(t.val),this._canvasSize<70&&(this._canvasSize=70),this._$preview.css({width:this._canvasSize+32}),this._$canvas.attr("width",this._canvasSize),this._$canvas.attr("height",this._canvasSize),T.setStampSize(Number(t.val))},e.prototype._changeType=function(t){return t.img?T.setStampImg(t.img):void 0},e.prototype._setPreview=function(){var t,e,n,i,s,o;return e=T.getStampIsFlipHorizontal(),n=T.getStampIsFlipVertical(),t=T.getStampImg(),i=T.getStampSize(),s=0,o=0,i<this._canvasSize&&(s=(this._canvasSize-i)/2,o=(this._canvasSize-i)/2),this._context.save(),this._context.clearRect(0,0,this._canvasSize,this._canvasSize),e&&!n?(this._context.scale(-1,1),this._context.translate(-this._canvasSize,0)):!e&&n?(this._context.scale(1,-1),this._context.translate(0,-this._canvasSize)):e&&n&&(this._context.scale(-1,-1),this._context.translate(-this._canvasSize,-this._canvasSize)),this._context.globalAlpha=T.getStampOpacity(),this._context.drawImage(t,s,o,i,i),this._context.restore()},e}(),y=function(){function t(t){this._$target=t.$target,this._file=new D.File({$target:$("#js-modalFile")}),this._stamp=new D.Stamp({$target:$("#js-modalStamp")}),this._danger=new D.Danger({$target:$("#js-modalDanger")}),this._msg=new D.Msg({$target:$("#js-modalMsg")}),this._upload=new D.Upload({$target:$("#js-modalUpload")})}return t.prototype.open=function(t){return t.id===d?this._file.open({src:t.data.src||null,img:t.data.img||null}):t.id===f?this._stamp.open({select:t.data.select,cancel:t.data.cancel}):t.id===g?this._danger.open({ttl:t.data.ttl,msg:t.data.msg,agree:t.data.agree,cancel:t.data.cancel}):t.id===m?this._msg.open({src:t.data.src,save:t.data.save}):t.id===v?this._upload.open({src:t.data.src,name:t.data.name,msg:t.data.msg,pw:t.data.pw}):void 0},t}(),D.Stamp=function(){function t(t){this._onSelect=bind(this._onSelect,this),this._onOpened=bind(this._onOpened,this),this._$target=t.$target,this._select=null,this._$target.on("shown.bs.modal",this._onOpened)}return t.prototype.open=function(t){return this._select=t.select||null,this._$target.modal({remote:"./modal-stamp.html"})},t.prototype._onOpened=function(){return $("input[name=js-toolStampType]").on("change",this._onSelect)},t.prototype._onSelect=function(t){var e;return e=$("img"),e.attr("src",$(t.target).val()),e.on("load",function(t){return function(){return t._select&&t._select({img:e.get(0)}),t._$target.modal("hide")}}(this))},t}(),D.Danger=function(){function t(t){this._onClose=bind(this._onClose,this),this._onCickCancel=bind(this._onCickCancel,this),this._onClickAgree=bind(this._onClickAgree,this),this._$target=t.$target,this._$ttl=$("#js-modalDangerTtl"),this._$txt=$("#js-modalDangerTxt"),this._$btnCancel=$("#js-modalDangerBtnCancel"),this._$btnAgree=$("#js-modalDangerBtnAgree"),this._cancel=null,this._agree=null,this._$btnAgree.on("click",this._onClickAgree),this._$btnCancel.on("click",this._onCickCancel)}return t.prototype.open=function(t){return this._agree=t.agree||null,this._cancel=t.cancel||null,this._$ttl.html(t.ttl),this._$txt.html(t.msg),this._$target.on("hidden.bs.modal",this._onClose),this._$target.modal("show")},t.prototype._onClickAgree=function(){return this._agree&&this._agree(),this._$target.off("hidden.bs.modal",this._onClose),this._$target.modal("hide")},t.prototype._onCickCancel=function(){return this._cancel&&this._cancel(),this._$target.off("hidden.bs.modal",this._onClose),this._$target.modal("hide")},t.prototype._onClose=function(){return this._$target.modal("hide"),this._cancel?this._cancel():void 0},t}(),D.File=function(){function e(t){this._onClose=bind(this._onClose,this),this._onClickDecide=bind(this._onClickDecide,this),this._onClickRotate=bind(this._onClickRotate,this),this._$target=t.$target,this._$btnRotate=$("#js-modalFileBtnRotate"),this._$btnDecide=$("#js-modalFileBtnDecide"),this._$canvas=$("#js-modalFileCanvas"),this._context=this._$canvas.get(0).getContext("2d"),this._img=null,this._src=null,this._$target.on("hidden.bs.modal",this._onClose),this._$btnRotate.on("click",this._onClickRotate),this._$btnDecide.on("click",this._onClickDecide)}return e.prototype.open=function(t){var e,n,o,a;return t.img&&(this._img=t.img,i/this._img.height<s/this._img.width?(n=s,e=s*(this._img.height/this._img.width),o=0,a=-(e-i)/2):(n=i*(this._img.width/this._img.height),e=i,o=-(n-s)/2,a=0),this._context.drawImage(this._img,o,a,n,e),this._$target.modal("show")),t.src?(this._src=t.src,this._img=new Image,this._img.src=this._src,this._img.onload=function(t){return function(){return i/t._img.height<s/t._img.width?(n=s,e=s*(t._img.height/t._img.width),o=0,a=-(e-i)/2):(n=i*(t._img.width/t._img.height),e=i,o=-(n-s)/2,a=0),t._context.drawImage(t._img,o,a,n,e),t._$target.modal("show")}}(this)):void 0},e.prototype._onClickRotate=function(){var t,e,n,o,a,r,h,c,_,l,u,p,g,d,m,f,v,$,y,b,C,S,w;for(h=this._context.getImageData(0,0,s,i),n=h.data,C=s,a=i,r=_=0,d=a;d>=0?d>=_:_>=d;r=d>=0?++_:--_)for(w=r*C,c=l=m=r,f=C;f>=m?f>=l:l>=f;c=f>=m?++l:--l)y=4*(w+c),b=4*(c*C+r),g=n[y],o=n[y+1],e=n[y+2],t=n[y+3],n[y]=n[b],n[y+1]=n[b+1],n[y+2]=n[b+2],n[y+3]=n[b+3],n[b]=g,n[b+1]=o,n[b+2]=e,n[b+3]=t;for(r=u=0,v=a;v>=0?v>=u:u>=v;r=v>=0?++u:--u)for(w=r*C,S=w+C,c=p=0,$=C/2;$>=0?$>=p:p>=$;c=$>=0?++p:--p)y=4*(w+c),b=4*(S-c),g=n[y],o=n[y+1],e=n[y+2],t=n[y+3],n[y]=n[b],n[y+1]=n[b+1],n[y+2]=n[b+2],n[y+3]=n[b+3],n[b]=g,n[b+1]=o,n[b+2]=e,n[b+3]=t;return this._context.clearRect(0,0,s,i),this._context.putImageData(h,0,0)},e.prototype._onClickDecide=function(){return t.trigger(_,[{target:this._$canvas.get(0),x:0,y:0,width:s,height:i}]),t.trigger(r),this._$target.modal("hide")},e.prototype._onClose=function(){return this._src=null,this._img=null,this._context.clearRect(0,0,s,i)},e}(),D.Msg=function(){function t(t){this._onClose=bind(this._onClose,this),this._onSave=bind(this._onSave,this),this._onChangeForm=bind(this._onChangeForm,this),this._startClose=bind(this._startClose,this),this._completeOpen=bind(this._completeOpen,this),this._$target=t.$target,this._$img=$("#js-modalMsgImg"),this._$inputName=$("#js-modalMsgInputName"),this._$textareaMsg=$("#js-modalMsgTextareaMsg"),this._$inputPw=$("#js-modalMsgInputPw"),this._$btnSave=$("#js-modalMsgBtnSave"),this._save=null,this._$target.on("shown.bs.modal",this._completeOpen),this._$target.on("hide.bs.modal",this._startClose),this._$target.on("hidden.bs.modal",this._onClose),this._$btnSave.on("click",this._onSave)}return t.prototype.open=function(t){var e;return e=t.src,this._save=t.save,this._$inputName.on("keydown keyup keypress change",this._onChangeForm),this._$textareaMsg.on("keydown keyup keypress change",this._onChangeForm),this._$inputPw.on("keydown keyup keypress change",this._onChangeForm),this._$inputName.val(null),this._$textareaMsg.val(null),this._$inputPw.val(null),this._$btnSave.prop("disabled",!0),e&&this._$img.attr("src",e),this._$target.modal("show")},t.prototype._completeOpen=function(){return $("#js-tool").css({display:"none"}),$("#js-info").css({display:"none"})},t.prototype._startClose=function(){return $("#js-tool").css({display:"block"}),$("#js-info").css({display:"block"})},t.prototype._onChangeForm=function(){var t,e;return e=this._$inputName.val(),t=this._$textareaMsg.val(),e&&t?this._$btnSave.prop("disabled",!1):this._$btnSave.prop("disabled",!0)},t.prototype._onSave=function(){var t,e,n;return e=this._$inputName.val(),t=this._$textareaMsg.val().replace(/\r?\n/g,"<br>"),n=this._$inputPw.val(),n||(n="0000"),this._save&&this._save({name:e,msg:t,pw:n}),this._$target.modal("hide")},t.prototype._onClose=function(){return this._$img.attr("src",""),this._$inputName.off("keydown keyup keypress change",this._onChangeForm),this._$textareaMsg.off("keydown keyup keypress change",this._onChangeForm),this._$inputPw.off("keydown keyup keypress change",this._onChangeForm)},t}(),D.Upload=function(){function e(t){this._onClickCreateAgain=bind(this._onClickCreateAgain,this),this._onClickToGallery=bind(this._onClickToGallery,this),this._onOpened=bind(this._onOpened,this),this._$target=t.$target,
this._$contentSending=$("#js-modalUploadContentSending"),this._$contentComplete=$("#js-modalUploadContentComplete"),this._$contentError=$("#js-modalUploadContentError"),this._$btnToGallery=$("#js-modalUploadBtnToGallery"),this._$btnCreateAgain=$("#js-modalUploadBtnCreateAgain"),this._id=null,this._pw=null,this._src=null,this._name=null,this._msg=null,this._$target.on("shown.bs.modal",this._onOpened),this._$btnToGallery.on("click",this._onClickToGallery),this._$btnCreateAgain.on("click",this._onClickCreateAgain)}return e.prototype.open=function(t){return this._id=null,this._src=t.src,this._name=t.name,this._msg=t.msg,this._pw=t.pw,this._toggleView({id:"sending"}),this._$target.modal({backdrop:"static",keyboard:!1})},e.prototype._onOpened=function(){var t;return t=this._src,t=t.replace(/^data:image\/png;base64,/,""),$.ajax({url:"api/upload.php",type:"POST",data:{pw:this._pw,image:t,name:encodeURIComponent(this._name),message:encodeURIComponent(this._msg)},dataType:"json",cache:!1,timeout:1e4}).done(function(t){return function(e){return t._toggleView({id:"complete"}),t._id=e.id}}(this)).fail(function(t){return function(e){return t._toggleView({id:"error"})}}(this))},e.prototype._onClickToGallery=function(){return this._id?location.href="./gallery.html#"+this._id:location.href="./gallery.html"},e.prototype._onClickCreateAgain=function(){return this._$target.modal("hide"),t.trigger(c)},e.prototype._toggleView=function(t){return"sending"===t.id?(this._$contentSending.css({display:"block"}),this._$contentComplete.css({display:"none"}),this._$contentError.css({display:"none"})):"complete"===t.id?(this._$contentSending.css({display:"none"}),this._$contentComplete.velocity({opacity:[1,0],translateY:[0,-50]},{duration:500,easing:"easeOutSine",display:"block"}),this._$contentError.css({display:"none"})):"error"===t.id?(this._$contentSending.css({display:"none"}),this._$contentComplete.css({display:"none"}),this._$contentError.velocity({opacity:[1,0],translateY:[0,-50]},{duration:500,easing:"easeOutSine",display:"block"})):void 0},e}(),t.on(_,function(t,e){return S.drawImage({target:e.target,x:e.x,y:e.y,width:e.width,height:e.height,opacity:e.opacity||1})}),t.on(r,function(){return S.addHistory()}),t.on(u,function(){return S.startDragAndDrop()}),t.on(l,function(t,e){return k.open({id:e.id,data:e.data||null})}),t.on(h,function(){return S.changTool()}),t.on(c,function(){return S.clear()}),T=new C,w=new p({$target:$("#js-header")}),S=new o({$target:$("#js-canvas")}),x=new b({$target:$("#js-tool")}),k=new y({$target:$("#js-modal")})});